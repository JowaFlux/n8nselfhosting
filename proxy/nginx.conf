server {
    listen 8080;

    # --- Webhooks: ohne Basic-Auth ---
    location ~* ^/(webhook|webhook-test)/ {
        # Optionales IP-Allowlisting
        # allow 203.0.113.0/24;
        # allow 198.51.100.42;
        # deny all;

        # Rate-Limit (z. B. 10 r/s)
        limit_req zone=webhooks burst=20 nodelay;

        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://host.docker.internal:5678;
    }

    # --- Rest: hinter Basic-Auth ---
    location / {
        auth_basic "Restricted";
        auth_basic_user_file /etc/nginx/.htpasswd;

        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://host.docker.internal:5678;
    }
}

# Rate-Limit-Zone (pro IP)
limit_req_zone $binary_remote_addr zone=webhooks:10m rate=10r/s;
